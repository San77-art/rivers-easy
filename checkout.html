<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout Profissional - Perfumaria Rivers</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Playfair+Display:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://sdk.mercadopago.com/js/v2"></script>
    <style>
        :root { --color-primary: #3b82f6; --color-success: #16a34a; }
        .checkout-container { display: grid; grid-template-columns: 1fr 350px; gap: 2rem; max-width: 1100px; margin: 2rem auto; padding: 0 1rem; }
        .card-box { background: white; padding: 2rem; border-radius: 1rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .hidden { display: none; }
        #status-screen { text-align: center; padding: 3rem; }
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); border-top: 4px solid var(--color-primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 1rem auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .form-input { width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 0.5rem; margin-bottom: 0.5rem; }
    </style>
</head>
<body>
    <header class="header">
        <div class="container"><a href="index.html" class="logo">PERFUMARIA RIVERS</a></div>
    </header>

    <div class="checkout-container">
        <div id="main-checkout">
            <div class="card-box" id="step-1">
                <h3 style="margin-bottom: 1.5rem;">ðŸ“¦ Dados de Entrega</h3>
                <form id="form-customer">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <input type="text" id="nome" placeholder="Nome Completo" class="form-input" required>
                        <input type="email" id="email" placeholder="E-mail" class="form-input" required>
                        <input type="text" id="cpf" placeholder="CPF (apenas nÃºmeros)" class="form-input" maxlength="11" required>
                        <input type="text" id="cep" placeholder="CEP" class="form-input" maxlength="8" required>
                    </div>
                    <input type="text" id="endereco" placeholder="EndereÃ§o Completo" class="form-input" style="margin-top:1rem" required>
                    <button type="button" class="btn btn-primary" style="margin-top: 1.5rem; width: 100%;" onclick="nextStep()">Ir para o Pagamento</button>
                </form>
            </div>

            <div id="payment-brick-container" class="hidden card-box" style="margin-top: 1rem;">
                <h3 style="margin-bottom: 1.5rem;">ðŸ’³ Pagamento Seguro</h3>
                <div id="paymentBrick_container"></div>
            </div>
        </div>

        <div class="card-box" style="height: fit-content;">
            <h3>Resumo</h3>
            <div id="order-items" style="margin: 1rem 0; font-size: 0.9rem;"></div>
            <hr>
            <div style="display: flex; justify-content: space-between; margin-top: 1rem; font-weight: bold;">
                <span>Total:</span>
                <span id="total-price">R$ 0,00</span>
            </div>
        </div>
    </div>

    <div id="status-screen" class="hidden container">
        <div class="card-box">
            <div id="payment-result">
                <div class="spinner"></div>
                <h2 id="status-title">Processando...</h2>
                <p id="status-msg">Assim que vocÃª pagar, esta tela atualizarÃ¡ sozinha.</p>
                <div id="pix-container" class="hidden">
                    <p>Escaneie ou copie o cÃ³digo PIX:</p>
                    <textarea id="pix-code" readonly style="width: 100%; height: 80px; margin: 1rem 0; font-family: monospace; font-size: 12px;"></textarea>
                    <button class="btn btn-secondary" onclick="copyPix()">Copiar CÃ³digo PIX</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const mp = new MercadoPago('APP_USR-18ea16ce-4d68-4769-bdd1-d8676d3dcc5e', { locale: 'pt-BR' });
        const BACKEND_URL = 'https://rivers-easy-1.onrender.com';
        let bricksBuilder = mp.bricks();
        let totalAmount = 0;

        function initSummary() {
            const cart = JSON.parse(localStorage.getItem("cart") || "[]");
            const itemsContainer = document.getElementById('order-items');
            totalAmount = cart.reduce((t, i) => t + (i.price * i.quantity), 0) + 25; 
            
            itemsContainer.innerHTML = cart.map(i => `<div style="display:flex; justify-content:space-between"><span>${i.name} x${i.quantity}</span><span>R$ ${ (i.price * i.quantity).toFixed(2) }</span></div>`).join('');
            document.getElementById('total-price').innerText = `R$ ${totalAmount.toFixed(2)}`;
        }

        async function nextStep() {
            const form = document.getElementById('form-customer');
            if(!form.checkValidity()) {
                alert("Por favor, preencha todos os campos corretamente.");
                return;
            }
            document.getElementById('step-1').classList.add('hidden');
            document.getElementById('payment-brick-container').classList.remove('hidden');
            renderPaymentBrick();
        }

        const renderPaymentBrick = async () => {
            const settings = {
                initialization: {
                    amount: totalAmount,
                    payer: {
                        email: document.getElementById('email').value,
                    },
                },
                customization: {
                    paymentMethods: {
                        ticket: ["pix"],
                        creditCard: "all",
                        installments: 1
                    },
                },
                callbacks: {
                    onReady: () => { console.log("Mercado Pago pronto."); },
                    onSubmit: ({ selectedPaymentMethod, formData }) => {
                        return new Promise((resolve, reject) => {
                            // Enviamos tudo para o seu servidor
                            fetch(`${BACKEND_URL}/api/create-pix`, { 
                                method: "POST",
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify({
                                    ...formData, // Aqui jÃ¡ vai o token do cartÃ£o se for cartÃ£o
                                    description: "Compra Perfumaria Rivers",
                                    payer: {
                                        email: document.getElementById('email').value,
                                        identification: { type: 'CPF', number: document.getElementById('cpf').value.replace(/\D/g, '') }
                                    }
                                }),
                            })
                            .then(res => res.json())
                            .then(data => {
                                showStatus(data);
                                resolve();
                            })
                            .catch(err => {
                                alert("Erro ao processar pagamento. Tente novamente.");
                                reject();
                            });
                        });
                    },
                    onError: (error) => { console.error(error); }
                },
            };
            window.paymentBrickController = await bricksBuilder.create('payment', 'paymentBrick_container', settings);
        };

        function showStatus(data) {
            document.querySelector('.checkout-container').classList.add('hidden');
            document.getElementById('status-screen').classList.remove('hidden');
            
            // Se for PIX, mostra o cÃ³digo
            if(data.point_of_interaction && data.point_of_interaction.transaction_data) {
                document.getElementById('status-title').innerText = "Aguardando Pagamento PIX";
                document.getElementById('pix-container').classList.remove('hidden');
                document.getElementById('pix-code').value = data.point_of_interaction.transaction_data.qr_code;
            } else {
                document.getElementById('status-title').innerText = "Processando seu CartÃ£o...";
            }
            
            // Polling para checar status no banco de dados
            const checkInterval = setInterval(async () => {
                try {
                    const res = await fetch(`${BACKEND_URL}/api/check-payment/${data.id}`);
                    const statusData = await res.json();
                    
                    if (statusData.status === 'approved') {
                        clearInterval(checkInterval);
                        document.getElementById('payment-result').innerHTML = `
                            <h1 style="color: var(--color-success)">âœ“ Pagamento Confirmado!</h1>
                            <p>Sua compra foi realizada com sucesso. Enviamos os detalhes para o seu e-mail.</p>
                            <button class="btn btn-primary" style="margin-top:1rem" onclick="window.location.href='index.html'">Voltar para a Loja</button>
                        `;
                        localStorage.removeItem("cart");
                    } else if (statusData.status === 'rejected') {
                        clearInterval(checkInterval);
                        alert("O pagamento foi recusado. Tente outro mÃ©todo.");
                        location.reload();
                    }
                } catch (e) { console.log("Aguardando aprovaÃ§Ã£o..."); }
            }, 5000);
        }

        function copyPix() {
            const copyText = document.getElementById("pix-code");
            copyText.select();
            navigator.clipboard.writeText(copyText.value);
            alert("CÃ³digo PIX copiado!");
        }

        initSummary();
    </script>
</body>
</html>