<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout Profissional - Perfumaria Rivers</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Playfair+Display:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://sdk.mercadopago.com/js/v2"></script>
    <style>
        :root { --color-primary: #3b82f6; --color-success: #16a34a; }
        body { background-color: #f9fafb; font-family: 'Inter', sans-serif; }
        .checkout-container { display: grid; grid-template-columns: 1fr 350px; gap: 2rem; max-width: 1100px; margin: 2rem auto; padding: 0 1rem; }
        .card-box { background: white; padding: 2rem; border-radius: 1rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .hidden { display: none; }
        #status-screen { text-align: center; padding: 3rem; margin-top: 2rem; }
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); border-top: 4px solid var(--color-primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 1rem auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .form-input { width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 0.5rem; margin-bottom: 0.5rem; box-sizing: border-box; }
        #pix-qr-code { width: 220px; height: 220px; margin: 1rem auto; display: block; border: 1px solid #ddd; padding: 10px; border-radius: 8px; background: white; }
        .header { background: white; padding: 1rem 0; border-bottom: 1px solid #eee; margin-bottom: 2rem; }
        .logo { font-family: 'Playfair Display', serif; font-weight: 700; font-size: 1.5rem; color: #1a1a1a; text-decoration: none; }
    </style>
</head>
<body>
    <header class="header">
        <div style="max-width: 1100px; margin: 0 auto; padding: 0 1rem;">
            <a href="index.html" class="logo">PERFUMARIA RIVERS</a>
        </div>
    </header>

    <div class="checkout-container">
        <div id="main-checkout">
            <div class="card-box" id="step-1">
                <h3 style="margin-bottom: 1.5rem;">üì¶ Dados de Entrega</h3>
                <form id="form-customer">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <input type="text" id="nome" placeholder="Nome Completo" class="form-input" required>
                        <input type="email" id="email" placeholder="E-mail" class="form-input" required>
                        <input type="text" id="cpf" placeholder="CPF (apenas n√∫meros)" class="form-input" maxlength="11" required>
                        <input type="text" id="cep" placeholder="CEP" class="form-input" maxlength="8" required>
                    </div>
                    <input type="text" id="endereco" placeholder="Endere√ßo Completo" class="form-input" style="margin-top:1rem" required>
                    <button type="button" class="btn btn-primary" style="margin-top: 1.5rem; width: 100%; padding: 1rem; background: var(--color-primary); color: white; border: none; border-radius: 0.5rem; cursor: pointer; font-weight: 600;" onclick="nextStep()">Ir para o Pagamento</button>
                </form>
            </div>

            <div id="payment-brick-container" class="hidden card-box" style="margin-top: 1rem;">
                <h3 style="margin-bottom: 1.5rem;">üí≥ Escolha como pagar</h3>
                <div id="paymentBrick_container"></div>
            </div>
        </div>

        <div class="card-box" style="height: fit-content;">
            <h3>Resumo</h3>
            <div id="order-items" style="margin: 1rem 0; font-size: 0.9rem; line-height: 1.6;"></div>
            <hr style="border: 0; border-top: 1px solid #eee;">
            <div style="display: flex; justify-content: space-between; margin-top: 1rem; font-weight: bold; font-size: 1.1rem;">
                <span>Total:</span>
                <span id="total-price">R$ 0,00</span>
            </div>
        </div>
    </div>

    <div id="status-screen" class="hidden container">
        <div class="card-box" style="max-width: 500px; margin: 0 auto;">
            <div id="payment-result">
                <h2 id="status-title">Processando seu pedido...</h2>
                <div id="loading-spinner" class="spinner"></div>
                
                <div id="pix-area" class="hidden">
                    <p style="color: #4b5563;">Escaneie o QR Code PIX abaixo:</p>
                    <img id="pix-qr-code" src="" alt="QR Code Pix">
                    <p style="margin-top: 10px; font-size: 0.9rem; color: #4b5563;">Ou copie o c√≥digo abaixo:</p>
                    <textarea id="pix-code" readonly style="width: 100%; height: 70px; margin: 1rem 0; font-family: monospace; font-size: 11px; padding: 10px; border: 1px dashed #3b82f6; background: #f8fafc; resize: none; border-radius: 4px;"></textarea>
                    <button class="btn btn-primary" onclick="copyPix()" style="width: 100%; padding: 0.8rem; background: var(--color-primary); color: white; border: none; border-radius: 0.5rem; cursor: pointer; font-weight: 600;">Copiar C√≥digo PIX</button>
                </div>
                
                <p id="status-msg" style="margin-top: 20px; color: #64748b; font-size: 0.9rem;">N√£o feche esta p√°gina at√© concluir o pagamento.</p>
            </div>
        </div>
    </div>

    <script>
        const mp = new MercadoPago('APP_USR-18ea16ce-4d68-4769-bdd1-d8676d3dcc5e', { locale: 'pt-BR' });
        const BACKEND_URL = 'https://rivers-easy-1.onrender.com';
        let bricksBuilder = mp.bricks();
        let totalAmount = 0;

        function initSummary() {
            const cart = JSON.parse(localStorage.getItem("cart") || "[]");
            if(cart.length === 0) {
                document.getElementById('order-items').innerHTML = "Carrinho vazio";
                return;
            }
            totalAmount = cart.reduce((t, i) => t + (i.price * i.quantity), 0) + 25; 
            document.getElementById('total-price').innerText = `R$ ${totalAmount.toFixed(2)}`;
            document.getElementById('order-items').innerHTML = cart.map(i => `
                <div style="display:flex; justify-content:space-between">
                    <span>${i.name} (x${i.quantity})</span>
                    <span>R$ ${(i.price * i.quantity).toFixed(2)}</span>
                </div>`).join('');
        }

        async function nextStep() {
            const form = document.getElementById('form-customer');
            if(!form.checkValidity()) { 
                alert("Por favor, preencha todos os campos corretamente."); 
                return; 
            }
            document.getElementById('step-1').classList.add('hidden');
            document.getElementById('payment-brick-container').classList.remove('hidden');
            renderPaymentBrick();
        }

        const renderPaymentBrick = async () => {
            const settings = {
                initialization: {
                    amount: totalAmount,
                    payer: { 
                        email: document.getElementById('email').value.trim() 
                    },
                },
                customization: {
                    paymentMethods: {
                        ticket: ["pix"],
                        creditCard: "all",
                        maxInstallments: 1
                    },
                    visual: {
                        hideStatusScreen: true,
                        preserveStyle: true
                    }
                },
                callbacks: {
                    onReady: () => { console.log("Checkout pronto"); },
                    onSubmit: ({ selectedPaymentMethod, formData }) => {
                        return new Promise((resolve, reject) => {
                            // Prepara a tela de transi√ß√£o
                            document.querySelector('.checkout-container').classList.add('hidden');
                            document.getElementById('status-screen').classList.remove('hidden');

                            // Limpeza rigorosa dos dados antes do envio
                            const payload = {
                                ...formData,
                                description: "Pedido Perfumaria Rivers",
                                payer: {
                                    email: document.getElementById('email').value.trim(),
                                    identification: { 
                                        type: 'CPF', 
                                        number: document.getElementById('cpf').value.replace(/\D/g, '') 
                                    }
                                }
                            };

                            fetch(`${BACKEND_URL}/api/process-payment`, { 
                                method: "POST",
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify(payload),
                            })
                            .then(res => res.json())
                            .then(data => {
                                if (data.error || data.status === 400 || data.status === 'rejected') {
                                    throw new Error(data.detail || "Pagamento recusado ou dados inv√°lidos.");
                                }
                                resolve();
                                showStatus(data);
                            })
                            .catch(err => {
                                alert("Erro ao processar: " + err.message);
                                // Se der erro, volta para a tela de pagamento
                                document.querySelector('.checkout-container').classList.remove('hidden');
                                document.getElementById('status-screen').classList.add('hidden');
                                reject();
                            });
                        });
                    },
                    onError: (error) => { 
                        console.error("Erro no Brick:", error);
                        alert("Erro ao carregar o checkout. Verifique sua conex√£o.");
                    }
                },
            };
            
            const container = document.getElementById('paymentBrick_container');
            container.innerHTML = ""; // Garante que n√£o haja duplicatas
            window.paymentBrickController = await bricksBuilder.create('payment', 'paymentBrick_container', settings);
        };

        function showStatus(data) {
            document.getElementById('loading-spinner').classList.add('hidden');
            
            // Caso seja PIX, exibe o QR Code
            if (data.point_of_interaction?.transaction_data) {
                const pix = data.point_of_interaction.transaction_data;
                document.getElementById('status-title').innerText = "Pagamento PIX Gerado";
                document.getElementById('pix-area').classList.remove('hidden');
                document.getElementById('pix-qr-code').src = `data:image/png;base64,${pix.qr_code_base64}`;
                document.getElementById('pix-code').value = pix.qr_code;
                document.getElementById('status-msg').innerText = "Aguardando confirma√ß√£o de pagamento...";
            } 
            // Caso seja Cart√£o aprovado na hora
            else if (data.status === 'approved') {
                document.getElementById('status-title').innerHTML = "<span style='color:var(--color-success)'>‚úì Pagamento Aprovado!</span>";
                document.getElementById('status-msg').innerText = "Obrigado! Seu pedido j√° est√° sendo preparado.";
                localStorage.removeItem("cart");
            } else {
                document.getElementById('status-title').innerText = "Status: " + data.status;
                document.getElementById('status-msg').innerText = "Estamos analisando seu pagamento.";
            }

            // Inicia a verifica√ß√£o autom√°tica (Polling)
            const checkStatusInterval = setInterval(async () => {
                try {
                    const res = await fetch(`${BACKEND_URL}/api/check-payment/${data.id}`);
                    const result = await res.json();
                    if (result.status === 'approved') {
                        clearInterval(checkStatusInterval);
                        document.getElementById('payment-result').innerHTML = `
                            <h2 style="color: var(--color-success)">‚úì Pago com Sucesso!</h2>
                            <p>Obrigado pela sua compra na Perfumaria Rivers.</p>
                            <button onclick="window.location.href='index.html'" style="margin-top:20px; padding:10px 20px; cursor:pointer;">Voltar √† Loja</button>
                        `;
                        localStorage.removeItem("cart");
                    }
                } catch (e) {
                    console.log("Erro na verifica√ß√£o autom√°tica");
                }
            }, 6000);
        }

        function copyPix() {
            const codeArea = document.getElementById("pix-code");
            codeArea.select();
            codeArea.setSelectionRange(0, 99999);
            navigator.clipboard.writeText(codeArea.value);
            alert("C√≥digo PIX copiado com sucesso!");
        }

        initSummary();
    </script>
</body>
</html>